<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Camera VLM Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .status.connected .status-dot {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .status.disconnected .status-dot {
            background: #dc3545;
        }

        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: bold;
            color: #007bff;
        }

        .controls-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .controls button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .controls button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Camera Overview Dashboard */
        .camera-dashboard {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .dashboard-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cameras-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .camera-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .camera-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .camera-card.active {
            border-left-color: #28a745;
            background: #f8fff8;
        }

        .camera-card.selected {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .camera-id {
            font-weight: bold;
            font-size: 1.1rem;
            color: #495057;
        }

        .camera-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
            transition: all 0.3s;
        }

        .camera-status.active {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .camera-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .camera-stat {
            text-align: center;
        }

        .camera-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
        }

        .camera-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
        }

        .camera-latest-vlm {
            background: #e7f3ff;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #007bff;
            font-style: italic;
            font-size: 0.9rem;
            line-height: 1.3;
            margin-top: 8px;
        }

        .camera-timestamp {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Camera specific colors */
        .camera-card[data-camera="0"] { border-left-color: #007bff; }
        .camera-card[data-camera="1"] { border-left-color: #28a745; }
        .camera-card[data-camera="2"] { border-left-color: #ffc107; }
        .camera-card[data-camera="3"] { border-left-color: #dc3545; }
        .camera-card[data-camera="4"] { border-left-color: #6f42c1; }
        .camera-card[data-camera="5"] { border-left-color: #fd7e14; }
        .camera-card[data-camera="6"] { border-left-color: #20c997; }
        .camera-card[data-camera="7"] { border-left-color: #e83e8c; }

        .camera-card[data-camera="0"] .camera-latest-vlm { border-left-color: #007bff; }
        .camera-card[data-camera="1"] .camera-latest-vlm { border-left-color: #28a745; }
        .camera-card[data-camera="2"] .camera-latest-vlm { border-left-color: #ffc107; }
        .camera-card[data-camera="3"] .camera-latest-vlm { border-left-color: #dc3545; }
        .camera-card[data-camera="4"] .camera-latest-vlm { border-left-color: #6f42c1; }
        .camera-card[data-camera="5"] .camera-latest-vlm { border-left-color: #fd7e14; }
        .camera-card[data-camera="6"] .camera-latest-vlm { border-left-color: #20c997; }
        .camera-card[data-camera="7"] .camera-latest-vlm { border-left-color: #e83e8c; }

        /* Camera Filters */
        .camera-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
        }

        .camera-filter-btn {
            background: white;
            border: 2px solid #dee2e6;
            color: #495057;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .camera-filter-btn:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .camera-filter-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }

        .view-toggle {
            display: flex;
            background: white;
            border-radius: 25px;
            overflow: hidden;
            border: 2px solid #dee2e6;
        }

        .view-toggle button {
            background: transparent;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-toggle button.active {
            background: #007bff;
            color: white;
        }

        /* VLM Messages */
        .vlm-messages {
            padding: 20px;
            max-height: 700px;
            overflow-y: auto;
        }

        .vlm-messages.grouped {
            padding: 0;
        }

        .camera-group {
            margin-bottom: 20px;
        }

        .camera-group-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-group-title {
            font-weight: bold;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .camera-group-count {
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .vlm-message {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        .vlm-message:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        /* Camera-specific message colors */
        .vlm-message[data-camera="0"] { border-left-color: #007bff; }
        .vlm-message[data-camera="1"] { border-left-color: #28a745; }
        .vlm-message[data-camera="2"] { border-left-color: #ffc107; }
        .vlm-message[data-camera="3"] { border-left-color: #dc3545; }
        .vlm-message[data-camera="4"] { border-left-color: #6f42c1; }
        .vlm-message[data-camera="5"] { border-left-color: #fd7e14; }
        .vlm-message[data-camera="6"] { border-left-color: #20c997; }
        .vlm-message[data-camera="7"] { border-left-color: #e83e8c; }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .vlm-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .vlm-message-type {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .vlm-message-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .camera-badge {
            background: #495057;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .vlm-message-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .vlm-message-content {
            font-size: 1rem;
            line-height: 1.5;
        }

        .vlm-details {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .detail-item {
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 500;
            color: #212529;
            margin-top: 2px;
        }

        .vlm-response {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-style: italic;
            border-left: 3px solid #007bff;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .footer {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                justify-content: center;
            }
            
            .cameras-overview {
                grid-template-columns: 1fr;
            }
            
            .camera-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .vlm-details {
                grid-template-columns: 1fr;
            }

            .vlm-message-header {
                flex-direction: column;
                align-items: stretch;
            }

            .vlm-message-meta {
                justify-content: space-between;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Multi-Camera VLM Analytics Dashboard</h1>
            <p>Real-time VLM analysis from multiple camera streams - Simple & Clean</p>
        </div>

        <div class="controls">
            <div class="status disconnected" id="status">
                <div class="status-dot"></div>
                <span id="status-text">Disconnected</span>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">Total Messages: </span>
                    <span class="stat-value" id="message-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Active Cameras: </span>
                    <span class="stat-value" id="active-cameras">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">VLM Results: </span>
                    <span class="stat-value" id="vlm-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Messages/min: </span>
                    <span class="stat-value" id="message-rate">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Uptime: </span>
                    <span class="stat-value" id="uptime">00:00</span>
                </div>
            </div>

            <div class="controls-buttons">
                <button id="connect-btn" onclick="connectWebSocket()">Connect VLM</button>
                <button id="disconnect-btn" onclick="disconnectWebSocket()" disabled>Disconnect</button>
                <button onclick="clearMessages()">Clear</button>
                <button onclick="exportData()">Export</button>
            </div>
        </div>

        <div class="camera-dashboard">
            <div class="dashboard-title">
                üìπ Camera Overview & Latest VLM Results
            </div>
            
            <div class="cameras-overview" id="cameras-overview">
                <!-- Camera cards will be dynamically generated -->
            </div>

            <div class="camera-filters">
                <span class="filter-label">Show VLM Messages:</span>
                <button class="camera-filter-btn active" onclick="filterMessages('all')" id="filter-all">
                    All Cameras
                </button>
                <div id="camera-filter-buttons">
                    <!-- Camera filter buttons will be dynamically generated -->
                </div>
                
                <div class="view-toggle">
                    <button class="active" onclick="toggleView('timeline')" id="view-timeline">Timeline</button>
                    <button onclick="toggleView('grouped')" id="view-grouped">By Camera</button>
                </div>
            </div>
        </div>

        <div class="vlm-messages" id="vlm-messages">
            <div class="empty-state">
                <h3>üîå Ready to Connect</h3>
                <p>Click "Connect VLM" to start receiving multi-camera VLM analytics</p>
                <p>Make sure your FastAPI VLM service is running on localhost:8000</p>
            </div>
        </div>

        <div class="footer">
            <p>üìä Multi-Camera VLM Analytics: Real-time AI insights from your camera network</p>
        </div>
    </div>

    <script>
        let websocket = null;
        let messageCount = 0;
        let vlmCount = 0;
        let startTime = null;
        let uptimeInterval = null;
        let messageRateInterval = null;
        let currentFilter = 'all';
        let currentView = 'timeline';
        let messageHistory = [];
        
        // Camera management
        let cameraStats = new Map(); // camera_id -> {messageCount, lastSeen, frameCounts, latestVLM}
        let allMessages = [];

        // Camera colors (matching CSS)
        const cameraColors = {
            '0': '#007bff', '1': '#28a745', '2': '#ffc107', '3': '#dc3545',
            '4': '#6f42c1', '5': '#fd7e14', '6': '#20c997', '7': '#e83e8c'
        };

        // Camera names (configurable)
        const cameraNames = {
            '0': 'Main Entrance',
            '1': 'Parking Lot',
            '2': 'Back Door',
            '3': 'Loading Area',
            '4': 'Perimeter North',
            '5': 'Perimeter South',
            '6': 'Storage Area',
            '7': 'Office Area'
        };

        // WebSocket connection
        function connectWebSocket() {
            const wsUrl = 'ws://localhost:8000/ws';
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('‚úÖ WebSocket connected');
                    updateStatus('connected', 'Connected to VLM Service');
                    updateButtons(true);
                    startUptime();
                    startMessageRateTracking();
                    addMessage('connection', 'VLM Analytics service connected successfully', { 
                        url: wsUrl,
                        timestamp: new Date().getTime()
                    });
                };

                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (error) {
                        console.error('‚ùå Failed to parse WebSocket message:', error);
                        addMessage('error', 'Failed to parse message: ' + error.message);
                    }
                };

                websocket.onclose = function(event) {
                    console.log('üì± WebSocket disconnected');
                    updateStatus('disconnected', 'Disconnected from VLM Service');
                    updateButtons(false);
                    stopUptime();
                    stopMessageRateTracking();
                    addMessage('connection', 'VLM Analytics service disconnected', {
                        code: event.code,
                        reason: event.reason || 'Unknown reason'
                    });
                };

                websocket.onerror = function(error) {
                    console.error('‚ùå WebSocket error:', error);
                    addMessage('error', 'VLM connection error. Make sure the FastAPI service is running on port 8000.');
                };

            } catch (error) {
                console.error('‚ùå Failed to create WebSocket:', error);
                addMessage('error', 'Failed to create WebSocket: ' + error.message);
            }
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        function handleMessage(data) {
            messageCount++;
            messageHistory.push({
                timestamp: Date.now(),
                data: data
            });
            document.getElementById('message-count').textContent = messageCount;

            if (data.type === 'vlm_result') {
                vlmCount++;
                document.getElementById('vlm-count').textContent = vlmCount;
                addVLMMessage(data);
                updateCameraStats(data.data);
            } else if (data.type === 'connection') {
                addMessage('connection', data.message || 'Connection established', {
                    client_id: data.client_id,
                    timestamp: data.timestamp
                });
            } else if (data.type === 'pong') {
                console.log('üèì Received pong from server');
            } else {
                addMessage('info', 'Received: ' + data.type, data);
            }

            updateCamerasOverview();
        }

        function updateCameraStats(vlmData) {
            const cameraId = vlmData.source_id.toString();
            
            if (!cameraStats.has(cameraId)) {
                cameraStats.set(cameraId, {
                    messageCount: 0,
                    lastSeen: Date.now(),
                    frameCount: new Map(),
                    lastFrame: 0,
                    models: new Set(),
                    latestVLM: null,
                    latestTimestamp: null
                });
            }

            const stats = cameraStats.get(cameraId);
            stats.messageCount++;
            stats.lastSeen = Date.now();
            stats.lastFrame = Math.max(stats.lastFrame, vlmData.frame_number);
            stats.models.add(vlmData.model_name);
            stats.latestVLM = vlmData.vlm_response;
            stats.latestTimestamp = Date.now();

            // Update active cameras count
            document.getElementById('active-cameras').textContent = cameraStats.size;

            // Update camera filter buttons
            updateCameraFilterButtons();
        }

        function updateCamerasOverview() {
            const container = document.getElementById('cameras-overview');
            container.innerHTML = '';

            cameraStats.forEach((stats, cameraId) => {
                const cameraCard = document.createElement('div');
                cameraCard.className = 'camera-card';
                cameraCard.setAttribute('data-camera', cameraId);
                cameraCard.onclick = () => filterMessages(cameraId);

                const timeSinceLastMessage = Math.floor((Date.now() - stats.lastSeen) / 1000);
                const isActive = timeSinceLastMessage < 30; // Active if message within 30 seconds

                const cameraName = cameraNames[cameraId] || `Camera ${cameraId}`;
                const latestVLM = stats.latestVLM || 'No VLM data received yet';
                const latestTime = stats.latestTimestamp ? new Date(stats.latestTimestamp).toLocaleTimeString() : '';

                cameraCard.innerHTML = `
                    <div class="camera-header">
                        <div class="camera-id">üìπ ${cameraName}</div>
                        <div class="camera-status ${isActive ? 'active' : ''}"></div>
                    </div>
                    <div class="camera-stats">
                        <div class="camera-stat">
                            <div class="camera-stat-value">${stats.messageCount}</div>
                            <div class="camera-stat-label">Messages</div>
                        </div>
                        <div class="camera-stat">
                            <div class="camera-stat-value">${stats.lastFrame}</div>
                            <div class="camera-stat-label">Last Frame</div>
                        </div>
                        <div class="camera-stat">
                            <div class="camera-stat-value">${isActive ? '‚úÖ' : '‚è∏Ô∏è'}</div>
                            <div class="camera-stat-label">Status</div>
                        </div>
                    </div>
                    <div class="camera-latest-vlm">
                        "${latestVLM}"
                    </div>
                    <div class="camera-timestamp">
                        Latest: ${latestTime || 'No data'}
                    </div>
                `;

                container.appendChild(cameraCard);
            });

            // If no cameras, show empty state
            if (cameraStats.size === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                        <h3>üìπ Waiting for Camera Data</h3>
                        <p>Connect to VLM service to see camera analytics</p>
                        <p>Camera cards will appear here as VLM data is received</p>
                    </div>
                `;
            }
        }

        function updateCameraFilterButtons() {
            const container = document.getElementById('camera-filter-buttons');
            
            cameraStats.forEach((stats, cameraId) => {
                // Check if button already exists
                const existingBtn = container.querySelector(`[data-camera="${cameraId}"]`);
                if (!existingBtn) {
                    const btn = document.createElement('button');
                    btn.className = 'camera-filter-btn';
                    btn.setAttribute('data-camera', cameraId);
                    btn.onclick = () => filterMessages(cameraId);
                    
                    const cameraName = cameraNames[cameraId] || `Cam ${cameraId}`;
                    btn.innerHTML = `üìπ ${cameraName} <span style="background: ${cameraColors[cameraId] || '#6c757d'}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; margin-left: 5px;">${stats.messageCount}</span>`;
                    container.appendChild(btn);
                } else {
                    // Update message count
                    const countSpan = existingBtn.querySelector('span');
                    if (countSpan) {
                        countSpan.textContent = stats.messageCount;
                    }
                }
            });
        }

        function addVLMMessage(data) {
            const vlm = data.data;
            const cameraId = vlm.source_id.toString();
            const cameraName = cameraNames[cameraId] || `Camera ${cameraId}`;
            
            const content = `
                <div class="vlm-response">
                    "${vlm.vlm_response}"
                </div>
                <div class="vlm-details">
                    <div class="detail-item">
                        <div class="detail-label">Camera</div>
                        <div class="detail-value">üìπ ${cameraName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Frame</div>
                        <div class="detail-value">#${vlm.frame_number}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Model</div>
                        <div class="detail-value">${vlm.model_name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Message ID</div>
                        <div class="detail-value">${vlm.message_id}</div>
                    </div>
                </div>
            `;
            
            const messageData = {
                type: 'vlm-result',
                text: `VLM Analysis from ${cameraName}`,
                cameraId: cameraId,
                content: content,
                timestamp: Date.now(),
                vlmData: vlm
            };

            allMessages.unshift(messageData);
            addMessageToDOM(messageData);

            // Limit stored messages to 500
            if (allMessages.length > 500) {
                allMessages = allMessages.slice(0, 500);
            }
        }

        function addMessage(type, text, details = null, customContent = null, cameraId = null) {
            const messageData = {
                type: type,
                text: text,
                cameraId: cameraId,
                content: customContent || '',
                details: details,
                timestamp: Date.now()
            };

            allMessages.unshift(messageData);
            addMessageToDOM(messageData);
        }

        function addMessageToDOM(messageData) {
            // Skip if filtered
            if (currentFilter !== 'all' && messageData.cameraId !== currentFilter) {
                return;
            }

            const messagesDiv = document.getElementById('vlm-messages');
            
            // Remove empty state
            if (messagesDiv.querySelector('.empty-state')) {
                messagesDiv.innerHTML = '';
            }

            // Check current view mode
            if (currentView === 'grouped') {
                addMessageGrouped(messageData, messagesDiv);
            } else {
                addMessageTimeline(messageData, messagesDiv);
            }
        }

        function addMessageTimeline(messageData, container) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `vlm-message ${messageData.type}`;
            if (messageData.cameraId) {
                messageDiv.setAttribute('data-camera', messageData.cameraId);
            }
            
            const timestamp = new Date(messageData.timestamp).toLocaleTimeString();
            const cameraName = messageData.cameraId ? 
                (cameraNames[messageData.cameraId] || `Camera ${messageData.cameraId}`) : '';
            const cameraBadge = messageData.cameraId ? 
                `<span class="camera-badge" style="background: ${cameraColors[messageData.cameraId] || '#6c757d'}">${cameraName}</span>` : '';

            let detailsHtml = '';
            if (messageData.details) {
                detailsHtml = '<pre style="margin-top: 10px; font-size: 0.9rem; background: #f1f3f4; padding: 10px; border-radius: 5px; overflow-x: auto;">' + JSON.stringify(messageData.details, null, 2) + '</pre>';
            }

            messageDiv.innerHTML = `
                <div class="vlm-message-header">
                    <div class="vlm-message-type">${messageData.type.replace('-', ' ')}</div>
                    <div class="vlm-message-meta">
                        ${cameraBadge}
                        <div class="vlm-message-time">${timestamp}</div>
                    </div>
                </div>
                <div class="vlm-message-content">
                    ${messageData.text}
                    ${messageData.content}
                    ${detailsHtml}
                </div>
            `;

            container.insertBefore(messageDiv, container.firstChild);

            // Limit to 50 visible messages in timeline mode
            const messages = container.querySelectorAll('.vlm-message');
            if (messages.length > 50) {
                messages[messages.length - 1].remove();
            }

            // Auto-scroll to top for new messages
            container.scrollTop = 0;
        }

        function addMessageGrouped(messageData, container) {
            if (!messageData.cameraId) {
                // Non-camera messages go to timeline
                addMessageTimeline(messageData, container);
                return;
            }

            const cameraName = cameraNames[messageData.cameraId] || `Camera ${messageData.cameraId}`;
            let cameraGroup = container.querySelector(`.camera-group[data-camera="${messageData.cameraId}"]`);
            
            if (!cameraGroup) {
                // Create new camera group
                cameraGroup = document.createElement('div');
                cameraGroup.className = 'camera-group';
                cameraGroup.setAttribute('data-camera', messageData.cameraId);
                
                const groupHeader = document.createElement('div');
                groupHeader.className = 'camera-group-header';
                groupHeader.style.borderLeftColor = cameraColors[messageData.cameraId] || '#6c757d';
                groupHeader.innerHTML = `
                    <div class="camera-group-title">
                        üìπ ${cameraName}
                    </div>
                    <div class="camera-group-count">1</div>
                `;
                
                cameraGroup.appendChild(groupHeader);
                container.appendChild(cameraGroup);
            }
            
            // Update message count
            const countElement = cameraGroup.querySelector('.camera-group-count');
            const currentCount = parseInt(countElement.textContent) + 1;
            countElement.textContent = currentCount;
            
            // Add message to group
            const messageDiv = document.createElement('div');
            messageDiv.className = `vlm-message ${messageData.type}`;
            messageDiv.setAttribute('data-camera', messageData.cameraId);
            
            const timestamp = new Date(messageData.timestamp).toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="vlm-message-header">
                    <div class="vlm-message-type">${messageData.type.replace('-', ' ')}</div>
                    <div class="vlm-message-time">${timestamp}</div>
                </div>
                <div class="vlm-message-content">
                    ${messageData.content}
                </div>
            `;
            
            cameraGroup.insertBefore(messageDiv, cameraGroup.children[1] || null);
            
            // Limit messages per camera group
            const groupMessages = cameraGroup.querySelectorAll('.vlm-message');
            if (groupMessages.length > 10) {
                groupMessages[groupMessages.length - 1].remove();
                countElement.textContent = currentCount - 1;
            }
        }

        function filterMessages(cameraId) {
            currentFilter = cameraId;
            
            // Update filter button states
            document.querySelectorAll('.camera-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (cameraId === 'all') {
                document.getElementById('filter-all').classList.add('active');
            } else {
                const btn = document.querySelector(`[data-camera="${cameraId}"]`);
                if (btn) btn.classList.add('active');
            }

            // Update camera card selection
            document.querySelectorAll('.camera-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (cameraId !== 'all') {
                const card = document.querySelector(`.camera-card[data-camera="${cameraId}"]`);
                if (card) card.classList.add('selected');
            }

            refreshMessages();
        }

        function toggleView(viewType) {
            currentView = viewType;
            
            // Update view toggle buttons
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`view-${viewType}`).classList.add('active');

            // Update messages container class
            const messagesDiv = document.getElementById('vlm-messages');
            messagesDiv.className = viewType === 'grouped' ? 'vlm-messages grouped' : 'vlm-messages';

            refreshMessages();
        }

        function refreshMessages() {
            const messagesDiv = document.getElementById('vlm-messages');
            messagesDiv.innerHTML = '';

            if (allMessages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>üìã No Messages</h3>
                        <p>Waiting for VLM analytics data...</p>
                    </div>
                `;
                return;
            }

            // Filter messages
            const filteredMessages = currentFilter === 'all' 
                ? allMessages 
                : allMessages.filter(msg => msg.cameraId === currentFilter);

            if (filteredMessages.length === 0) {
                const cameraName = cameraNames[currentFilter] || `Camera ${currentFilter}`;
                messagesDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>üìπ No Messages from ${cameraName}</h3>
                        <p>No VLM data from this camera yet</p>
                    </div>
                `;
                return;
            }

            // Display messages based on view type
            if (currentView === 'grouped') {
                // Group messages by camera
                const messagesByCamera = new Map();
                filteredMessages.forEach(msg => {
                    if (msg.cameraId) {
                        if (!messagesByCamera.has(msg.cameraId)) {
                            messagesByCamera.set(msg.cameraId, []);
                        }
                        messagesByCamera.get(msg.cameraId).push(msg);
                    }
                });
                
                // Display grouped messages
                messagesByCamera.forEach((messages, cameraId) => {
                    messages.slice(0, 10).forEach(messageData => {
                        addMessageGrouped(messageData, messagesDiv);
                    });
                });
            } else {
                // Timeline view
                filteredMessages.slice(0, 50).forEach(messageData => {
                    addMessageTimeline(messageData, messagesDiv);
                });
            }
        }

        function updateStatus(status, text) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            
            statusEl.className = `status ${status}`;
            statusText.textContent = text;
        }

        function updateButtons(connected) {
            document.getElementById('connect-btn').disabled = connected;
            document.getElementById('disconnect-btn').disabled = !connected;
        }

        function clearMessages() {
            allMessages = [];
            cameraStats.clear();
            messageCount = 0;
            vlmCount = 0;
            
            document.getElementById('vlm-messages').innerHTML = `
                <div class="empty-state">
                    <h3>üìã Messages Cleared</h3>
                    <p>Waiting for new VLM analytics data...</p>
                </div>
            `;
            
            document.getElementById('message-count').textContent = messageCount;
            document.getElementById('vlm-count').textContent = vlmCount;
            document.getElementById('active-cameras').textContent = 0;
            
            updateCamerasOverview();
            
            // Clear filter buttons
            document.getElementById('camera-filter-buttons').innerHTML = '';
        }

        function exportData() {
            const exportData = {
                timestamp: new Date().toISOString(),
                messageCount: messageCount,
                vlmCount: vlmCount,
                activeCameras: cameraStats.size,
                cameraStats: Object.fromEntries(cameraStats),
                recentMessages: allMessages.slice(0, 100) // Last 100 messages
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `vlm-analytics-export-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.click();
            
            console.log('üìä VLM analytics data exported');
        }

        function startUptime() {
            startTime = Date.now();
            uptimeInterval = setInterval(updateUptime, 1000);
        }

        function stopUptime() {
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
                uptimeInterval = null;
            }
            document.getElementById('uptime').textContent = '00:00';
        }

        function updateUptime() {
            if (!startTime) return;
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startMessageRateTracking() {
            messageRateInterval = setInterval(() => {
                // Calculate messages per minute from last minute of data
                const oneMinuteAgo = Date.now() - 60000;
                const recentMessages = messageHistory.filter(msg => msg.timestamp > oneMinuteAgo);
                document.getElementById('message-rate').textContent = recentMessages.length;
                
                // Cleanup old message history (keep last 5 minutes)
                const fiveMinutesAgo = Date.now() - 300000;
                messageHistory = messageHistory.filter(msg => msg.timestamp > fiveMinutesAgo);
            }, 10000); // Update every 10 seconds
        }

        function stopMessageRateTracking() {
            if (messageRateInterval) {
                clearInterval(messageRateInterval);
                messageRateInterval = null;
            }
            document.getElementById('message-rate').textContent = '0';
        }

        // Send ping every 30 seconds to keep connection alive
        function startPingInterval() {
            return setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'ping',
                        timestamp: Date.now()
                    }));
                }
            }, 30000);
        }

        let pingInterval = null;

        // Auto-connect on page load
        window.addEventListener('load', function() {
            console.log('üìä Multi-Camera VLM Analytics Dashboard Loaded');
            console.log('üí° Make sure FastAPI VLM service is running: localhost:8000');
            
            // Auto-connect after 1 second
            setTimeout(() => {
                connectWebSocket();
                pingInterval = startPingInterval();
            }, 1000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (pingInterval) {
                clearInterval(pingInterval);
            }
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>
</html>